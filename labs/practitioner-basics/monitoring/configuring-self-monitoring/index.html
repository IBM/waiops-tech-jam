<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-practitioner-basics/monitoring/configuring-self-monitoring">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Configuring self-monitoring | IBM AIOps Automation SWAT</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://github.com/waiops-tech-jam/labs/practitioner-basics/monitoring/configuring-self-monitoring/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Configuring self-monitoring | IBM AIOps Automation SWAT"><meta data-rh="true" name="description" content="How to configure self-monitoring of IBM CloudPak for AIOps with OpenShift"><meta data-rh="true" property="og:description" content="How to configure self-monitoring of IBM CloudPak for AIOps with OpenShift"><link data-rh="true" rel="icon" href="/waiops-tech-jam/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://github.com/waiops-tech-jam/labs/practitioner-basics/monitoring/configuring-self-monitoring/"><link data-rh="true" rel="alternate" href="https://github.com/waiops-tech-jam/labs/practitioner-basics/monitoring/configuring-self-monitoring/" hreflang="en"><link data-rh="true" rel="alternate" href="https://github.com/waiops-tech-jam/labs/practitioner-basics/monitoring/configuring-self-monitoring/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/waiops-tech-jam/blog/rss.xml" title="IBM AIOps Automation SWAT RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/waiops-tech-jam/blog/atom.xml" title="IBM AIOps Automation SWAT Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7WTTHT6SEH"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-7WTTHT6SEH",{anonymize_ip:!0})</script><link rel="stylesheet" href="/waiops-tech-jam/assets/css/styles.f87e0e6c.css">
<link rel="preload" href="/waiops-tech-jam/assets/js/runtime~main.bf944562.js" as="script">
<link rel="preload" href="/waiops-tech-jam/assets/js/main.df3d1d6f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/waiops-tech-jam/"><div class="navbar__logo"><img src="/waiops-tech-jam/img/ibm-watson-logo.png" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/waiops-tech-jam/img/ibm-watson-logo.png" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">IBM SWAT</b></a><a class="navbar__item navbar__link" href="/waiops-tech-jam/labs/jam-in-a-box/">Labs</a><a class="navbar__item navbar__link" href="/waiops-tech-jam/blog/">Guides</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/IBM/waiops-tech-jam" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/waiops-tech-jam/labs/jam-in-a-box/">Jam-in-a-Box</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/waiops-tech-jam/labs/practitioner-basics/">Practitioner Basics</a><button aria-label="Toggle the collapsible sidebar category &#x27;Practitioner Basics&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/waiops-tech-jam/labs/practitioner-basics/solution-design/architecture/">1. Solution Design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/waiops-tech-jam/labs/practitioner-basics/cluster-design/node-sizing/">2. Cluster Design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/waiops-tech-jam/labs/practitioner-basics/storage/intro/">3. Storage</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/waiops-tech-jam/labs/practitioner-basics/monitoring/configuring-self-monitoring/">4. Self monitoring</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/waiops-tech-jam/labs/practitioner-basics/monitoring/configuring-self-monitoring/">Configuring self-monitoring</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/waiops-tech-jam/labs/instana/introduction/">Instana Labs</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/waiops-tech-jam/labs/turbonomic/introduction/">Turbonomic Labs</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/waiops-tech-jam/labs/cloud-pak-aiops/introduction/">Cloud Pak for AIOps Labs</a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/waiops-tech-jam/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/waiops-tech-jam/labs/practitioner-basics/"><span itemprop="name">Practitioner Basics</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">4. Self monitoring</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Configuring self-monitoring</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Configuring self-monitoring</h1></header><p>This page covers some strategies for observing IBM CloudPak for AIOps KPIs and how to
configure them.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="examining-kpis-and-other-metrics-using-user-workload-monitoring">Examining KPIs and other metrics using User Workload Monitoring<a href="#examining-kpis-and-other-metrics-using-user-workload-monitoring" class="hash-link" aria-label="Direct link to Examining KPIs and other metrics using User Workload Monitoring" title="Direct link to Examining KPIs and other metrics using User Workload Monitoring">​</a></h2><p>OpenShift comes with a prometheus-based monitoring stack, which out of the box is used to
track metrics about the cluster.</p><p>It is possible to extend this monitoring to &#x27;user workloads&#x27; (i.e. anything that is not a
core OCP service), by <a href="https://docs.openshift.com/container-platform/4.15/observability/monitoring/enabling-monitoring-for-user-defined-projects.html" target="_blank" rel="noopener noreferrer">enabling user workload monitoring</a>. This will deploy a secondary prometheus instance, which can be queried alongside
the cluster-level prometheus, as if it was one instance, using <a href="https://thanos.io" target="_blank" rel="noopener noreferrer">thanos</a>.</p><p>There are various services in AIOps which are capable of exposing metrics to prometheus
in this way.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="enabling-user-workload-monitoring">Enabling user workload monitoring<a href="#enabling-user-workload-monitoring" class="hash-link" aria-label="Direct link to Enabling user workload monitoring" title="Direct link to Enabling user workload monitoring">​</a></h3><p>The first step is to enable the capability, if it has not been already. This is a
cluster-wide setting, so care should be taken if this is being applied to a shared cluseter.</p><p>It can be enabled by running the following commands when logged into the cluster:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">oc create -n openshift-monitoring -f - </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">||</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation boolean" style="color:#36acaa">true</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    app.kubernetes.io/created-by: vision-deploy-tool</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: cluster-monitoring-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespace: openshift-monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  config.yaml: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    enableUserWorkload: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oc create -n openshift-user-workload-monitoring -f - </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">||</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation boolean" style="color:#36acaa">true</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    app.kubernetes.io/created-by: vision-deploy-tool</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: user-workload-monitoring-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespace: openshift-user-workload-monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  config.yaml: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>More advanced configuration is possible; refer to the
<a href="https://docs.openshift.com/container-platform/4.15/observability/monitoring/enabling-monitoring-for-user-defined-projects.html" target="_blank" rel="noopener noreferrer">OpenShift documentation</a> for more details.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="viewing-metrics-in-the-ocp-console">Viewing metrics in the OCP console<a href="#viewing-metrics-in-the-ocp-console" class="hash-link" aria-label="Direct link to Viewing metrics in the OCP console" title="Direct link to Viewing metrics in the OCP console">​</a></h3><p>At this point, some AIOps metrics will become available in the OCP console under
<code>Observe -&gt; Metrics</code>. This will allow you to enter any
<a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank" rel="noopener noreferrer">prometheus query</a> and graph the result.</p><p>Below are some example queries for AIOps metrics:</p><ol><li>Rate of events ingested by lifecycle over time:<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sum(irate((flink_taskmanager_job_task_operator_KafkaSourceReader_topic_partition_currentOffset{topic=&quot;cp4waiops_cartridge_lifecycle_input_events&quot;}&gt;0)[1m:30s]))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>Rate of alert update messages processed by lifecycle over time:<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sum(irate((flink_taskmanager_job_task_operator_KafkaSourceReader_topic_partition_currentOffset{topic=&quot;cp4waiops_cartridge_lifecycle_input_alerts&quot;}&gt;0)[1m:30s]))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>Average kafka message size for messages produced by lifecycle:<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sum(flink_taskmanager_job_task_operator_KafkaProducer_record_size_avg &gt; 0) by (operator_name)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>Lifecycle kafka consumer lag (i.e. how far behind the latest message it is):<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sum by (task_name, subtask_index) (flink_taskmanager_job_task_operator_pendingRecords)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="enabling-additional-metrics">Enabling additional metrics<a href="#enabling-additional-metrics" class="hash-link" aria-label="Direct link to Enabling additional metrics" title="Direct link to Enabling additional metrics">​</a></h3><p>While some components enable metric scraping out of the box (e.g. lifecycle, as in the examples
above), others need additional configuration.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="kafka">Kafka<a href="#kafka" class="hash-link" aria-label="Direct link to Kafka" title="Direct link to Kafka">​</a></h4><p>A large portion of the communication in AIOps happens over Kafka, so scraping metrics from this
is highly valuable.</p><p>The kafka prometheus exporter can be enabled and configured by running the following commands in the
AIOps namespace:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">KAFKA_METRICS_CONFIGMAP</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: kafka-metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    app: strimzi</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  kafka-metrics-config.yml: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    # See https://github.com/prometheus/jmx_exporter for more info about JMX Prometheus Exporter metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    lowercaseOutputName: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    # Special cases and very specific rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.server&lt;type=(.+), name=(.+), clientId=(.+), topic=(.+), partition=(.*)&gt;&lt;&gt;Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_server_$1_$2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">       clientId: &quot;$3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">       topic: &quot;$4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">       partition: &quot;$5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.server&lt;type=(.+), name=(.+), clientId=(.+), brokerHost=(.+), brokerPort=(.+)&gt;&lt;&gt;Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_server_$1_$2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">       clientId: &quot;$3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">       broker: &quot;$4:$5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.server&lt;type=(.+), cipher=(.+), protocol=(.+), listener=(.+), networkProcessor=(.+)&gt;&lt;&gt;connections</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_server_$1_connections_tls_info</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        cipher: &quot;$2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        protocol: &quot;$3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        listener: &quot;$4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        networkProcessor: &quot;$5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.server&lt;type=(.+), clientSoftwareName=(.+), clientSoftwareVersion=(.+), listener=(.+), networkProcessor=(.+)&gt;&lt;&gt;connections</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_server_$1_connections_software</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        clientSoftwareName: &quot;$2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        clientSoftwareVersion: &quot;$3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        listener: &quot;$4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        networkProcessor: &quot;$5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: &quot;kafka.server&lt;type=(.+), listener=(.+), networkProcessor=(.+)&gt;&lt;&gt;(.+):&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_server_$1_$4</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">       listener: &quot;$2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">       networkProcessor: &quot;$3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.server&lt;type=(.+), listener=(.+), networkProcessor=(.+)&gt;&lt;&gt;(.+)</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_server_$1_$4</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">       listener: &quot;$2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">       networkProcessor: &quot;$3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    # Some percent metrics use MeanRate attribute</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    # Ex) kafka.server&lt;type=(KafkaRequestHandlerPool), name=(RequestHandlerAvgIdlePercent)&gt;&lt;&gt;MeanRate</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.(\w+)&lt;type=(.+), name=(.+)Percent\w*&gt;&lt;&gt;MeanRate</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_$1_$2_$3_percent</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    # Generic gauges for percents</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.(\w+)&lt;type=(.+), name=(.+)Percent\w*&gt;&lt;&gt;Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_$1_$2_$3_percent</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.(\w+)&lt;type=(.+), name=(.+)Percent\w*, (.+)=(.+)&gt;&lt;&gt;Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_$1_$2_$3_percent</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;$4&quot;: &quot;$5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    # Generic per-second counters with 0-2 key/value pairs</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.(\w+)&lt;type=(.+), name=(.+)PerSec\w*, (.+)=(.+), (.+)=(.+)&gt;&lt;&gt;Count</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_$1_$2_$3_total</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: COUNTER</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;$4&quot;: &quot;$5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;$6&quot;: &quot;$7&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.(\w+)&lt;type=(.+), name=(.+)PerSec\w*, (.+)=(.+)&gt;&lt;&gt;Count</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_$1_$2_$3_total</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: COUNTER</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;$4&quot;: &quot;$5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.(\w+)&lt;type=(.+), name=(.+)PerSec\w*&gt;&lt;&gt;Count</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_$1_$2_$3_total</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: COUNTER</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    # Generic gauges with 0-2 key/value pairs</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.(\w+)&lt;type=(.+), name=(.+), (.+)=(.+), (.+)=(.+)&gt;&lt;&gt;Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_$1_$2_$3</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;$4&quot;: &quot;$5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;$6&quot;: &quot;$7&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.(\w+)&lt;type=(.+), name=(.+), (.+)=(.+)&gt;&lt;&gt;Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_$1_$2_$3</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;$4&quot;: &quot;$5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.(\w+)&lt;type=(.+), name=(.+)&gt;&lt;&gt;Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_$1_$2_$3</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    # Emulate Prometheus &#x27;</span><span class="token plain">Summary</span><span class="token string" style="color:#e3116c">&#x27; metrics for the exported &#x27;</span><span class="token plain">Histogram</span><span class="token string" style="color:#e3116c">&#x27;s.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    # Note that these are missing the &#x27;</span><span class="token plain">_sum</span><span class="token string" style="color:#e3116c">&#x27; metric!</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.(\w+)&lt;type=(.+), name=(.+), (.+)=(.+), (.+)=(.+)&gt;&lt;&gt;Count</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_$1_$2_$3_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: COUNTER</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;$4&quot;: &quot;$5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;$6&quot;: &quot;$7&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.(\w+)&lt;type=(.+), name=(.+), (.+)=(.*), (.+)=(.+)&gt;&lt;&gt;(\d+)thPercentile</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_$1_$2_$3</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;$4&quot;: &quot;$5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;$6&quot;: &quot;$7&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        quantile: &quot;0.$8&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.(\w+)&lt;type=(.+), name=(.+), (.+)=(.+)&gt;&lt;&gt;Count</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_$1_$2_$3_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: COUNTER</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;$4&quot;: &quot;$5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.(\w+)&lt;type=(.+), name=(.+), (.+)=(.*)&gt;&lt;&gt;(\d+)thPercentile</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_$1_$2_$3</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;$4&quot;: &quot;$5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        quantile: &quot;0.$6&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.(\w+)&lt;type=(.+), name=(.+)&gt;&lt;&gt;Count</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_$1_$2_$3_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: COUNTER</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: kafka.(\w+)&lt;type=(.+), name=(.+)&gt;&lt;&gt;(\d+)thPercentile</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: kafka_$1_$2_$3</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        quantile: &quot;0.$4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  zookeeper-metrics-config.yml: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    # See https://github.com/prometheus/jmx_exporter for more info about JMX Prometheus Exporter metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    lowercaseOutputName: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    # replicated Zookeeper</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: &quot;org.apache.ZooKeeperService&lt;name0=ReplicatedServer_id(\\d+)&gt;&lt;&gt;(\\w+)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: &quot;zookeeper_$2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: &quot;org.apache.ZooKeeperService&lt;name0=ReplicatedServer_id(\\d+), name1=replica.(\\d+)&gt;&lt;&gt;(\\w+)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: &quot;zookeeper_$3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        replicaId: &quot;$2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: &quot;org.apache.ZooKeeperService&lt;name0=ReplicatedServer_id(\\d+), name1=replica.(\\d+), name2=(\\w+)&gt;&lt;&gt;(Packets\\w+)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: &quot;zookeeper_$4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: COUNTER</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        replicaId: &quot;$2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        memberType: &quot;$3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: &quot;org.apache.ZooKeeperService&lt;name0=ReplicatedServer_id(\\d+), name1=replica.(\\d+), name2=(\\w+)&gt;&lt;&gt;(\\w+)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: &quot;zookeeper_$4&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        replicaId: &quot;$2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        memberType: &quot;$3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - pattern: &quot;org.apache.ZooKeeperService&lt;name0=ReplicatedServer_id(\\d+), name1=replica.(\\d+), name2=(\\w+), name3=(\\w+)&gt;&lt;&gt;(\\w+)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: &quot;zookeeper_$4_$5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: GAUGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        replicaId: &quot;$2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        memberType: &quot;$3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">KAFKA_PODMONITOR</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: monitoring.coreos.com/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: PodMonitor</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: kafka-resources-metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    app: strimzi</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      - key: &quot;ibmevents.ibm.com/kind&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        operator: In</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        values: [&quot;Kafka&quot;, &quot;KafkaConnect&quot;, &quot;KafkaMirrorMaker&quot;, &quot;KafkaMirrorMaker2&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespaceSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    matchNames:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      - myproject</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  podMetricsEndpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - path: /metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    port: tcp-prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    relabelings:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - separator: ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      regex: __meta_kubernetes_pod_label_(ibmevents_ibm_com_.+)</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      replacement: $1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      action: labelmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - sourceLabels: [__meta_kubernetes_namespace]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      separator: ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      regex: (.*)</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      targetLabel: namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      replacement: $1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      action: replace</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - sourceLabels: [__meta_kubernetes_pod_name]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      separator: ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      regex: (.*)</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      targetLabel: kubernetes_pod_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      replacement: $1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      action: replace</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - sourceLabels: [__meta_kubernetes_pod_node_name]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      separator: ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      regex: (.*)</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      targetLabel: node_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      replacement: $1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      action: replace</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - sourceLabels: [__meta_kubernetes_pod_host_ip]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      separator: ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      regex: (.*)</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      targetLabel: node_ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      replacement: $1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      action: replace</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oc apply -f - </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><span class="token string variable" style="color:#36acaa">${KAFKA_METRICS_CONFIGMAP}</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><span class="token string variable" style="color:#36acaa">${KAFKA_PODMONITOR}</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oc patch kafka iaf-system --type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">merge -p </span><span class="token string" style="color:#e3116c">&#x27;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  &quot;spec&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    &quot;kafka&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      &quot;metricsConfig&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;type&quot;: &quot;jmxPrometheusExporter&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        &quot;valueFrom&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          &quot;configMapKeyRef&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;key&quot;: &quot;kafka-metrics-config.yml&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            &quot;name&quot;: &quot;kafka-metrics&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>One these commands are run, the kafka brokers will perform a rolling restart in order to enable the metric exporter.</p><p>You will then be able to explore kafka broker metrics in the openshift console, for example:</p><ol><li>Rate of messages published per kafka topic:<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sum by (topic) (irate(kafka_server_brokertopicmetrics_messagesin_total{topic!=&quot;&quot;}[1m]))</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="viewing-metrics-in-grafana">Viewing metrics in Grafana<a href="#viewing-metrics-in-grafana" class="hash-link" aria-label="Direct link to Viewing metrics in Grafana" title="Direct link to Viewing metrics in Grafana">​</a></h3><p>Whilst all metrics can be explored in the OCP console, it is fairly limited when it comes to visualization types
and there is no way to construct and save a dashboard of multiple charts.</p><p>It is possible to install Grafana into OpenShift and configure it to connect to Thanos. This will give it access to
all metrics across all of the prometheus instances (both cluster and user workload metrics).</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="installation">Installation<a href="#installation" class="hash-link" aria-label="Direct link to Installation" title="Direct link to Installation">​</a></h4><p>As a quick start, this can be installed with the following script:</p><div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token coord">@@ NOTE: This will not work for airgap deployments as it relies on pulling grafana from public registries @@</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oc create -f - </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: monitoring-grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: operators.coreos.com/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: OperatorGroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: operatorgroup</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespace: monitoring-grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  targetNamespaces:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - monitoring-grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: operators.coreos.com/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Subscription</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: monitoring-grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  namespace: monitoring-grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  channel: v4</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  installPlanApproval: Automatic</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: grafana-operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  source: community-operators</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  sourceNamespace: openshift-marketplace</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oc project monitoring-grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">installReady</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$installReady</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">installPlan</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">oc get subscription.operators.coreos.com monitoring-grafana -n monitoring-grafana -o json </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> jq -r .status.installplan.name</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -z </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$installPlan</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token assign-left variable" style="color:#36acaa">installReady</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token assign-left variable" style="color:#36acaa">installReady</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">oc get installplan -n monitoring-grafana </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$installPlan</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa"> -o json </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> jq -r </span><span class="token variable string" style="color:#e3116c">&#x27;.status|.phase == &quot;Complete&quot;&#x27;</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$installReady</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">installReady</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$installReady</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">csv</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">oc get subscription.operators.coreos.com monitoring-grafana -n monitoring-grafana -o json </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> jq -r .status.currentCSV</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> -z </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$csv</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token assign-left variable" style="color:#36acaa">installReady</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token assign-left variable" style="color:#36acaa">installReady</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">oc get csv -n monitoring-grafana </span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable string variable" style="color:#36acaa">$csv</span><span class="token variable string" style="color:#e3116c">&quot;</span><span class="token variable" style="color:#36acaa"> -o json </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> jq -r </span><span class="token variable string" style="color:#e3116c">&#x27;.status.phase == &quot;Succeeded&quot;&#x27;</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$installReady</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oc create -n monitoring-grafana -f - </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: integreatly.org/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  baseImage: docker.io/grafana/grafana-oss:9.4.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    log:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      mode: &quot;console&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      level: &quot;warn&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    auth:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      disable_login_form: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      disable_signout_menu: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    auth.basic:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    auth.anonymous:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      org_role: Admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  deployment:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      - name: GRAFANA_TOKEN</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        valueFrom:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          secretKeyRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            name: grafana-auth-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            key: token</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - name: SAR</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          value: &#x27;-openshift-sar={&quot;resource&quot;: &quot;namespaces&quot;, &quot;verb&quot;: &quot;get&quot;}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &#x27;-provider=openshift&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &#x27;-pass-basic-auth=false&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &#x27;-https-address=:9091&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &#x27;-http-address=&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &#x27;-email-domain=*&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &#x27;-upstream=http://localhost:3000&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &quot;\</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable" style="color:#36acaa">SAR</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &#x27;-openshift-delegate-urls={&quot;/&quot;: {&quot;resource&quot;: &quot;namespaces&quot;, &quot;verb&quot;: &quot;get&quot;}}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &#x27;-tls-cert=/etc/tls/private/tls.crt&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &#x27;-tls-key=/etc/tls/private/tls.key&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &#x27;-client-secret-file=/var/run/secrets/kubernetes.io/serviceaccount/token&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &#x27;-cookie-secret-file=/etc/proxy/secrets/session_secret&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &#x27;-openshift-service-account=grafana-serviceaccount&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &#x27;-openshift-ca=/etc/pki/tls/cert.pem&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &#x27;-openshift-ca=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &#x27;-skip-auth-regex=^/metrics&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      image: &#x27;registry.redhat.io/openshift4/ose-oauth-proxy:v4.10&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      imagePullPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: grafana-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - containerPort: 9091</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          name: grafana-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      resources: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - mountPath: /etc/tls/private</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          name: secret-grafana-k8s-tls</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          readOnly: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - mountPath: /etc/proxy/secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          name: secret-grafana-k8s-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          readOnly: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  secrets:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - grafana-k8s-tls</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - grafana-k8s-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  service:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      - name: grafana-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        port: 9091</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        targetPort: grafana-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      service.alpha.openshift.io/serving-cert-secret-name: grafana-k8s-tls</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    targetPort: grafana-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    termination: reencrypt</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  client:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    preferService: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  serviceAccount:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      serviceaccounts.openshift.io/oauth-redirectreference.primary: &#x27;{&quot;kind&quot;:&quot;OAuthRedirectReference&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;reference&quot;:{&quot;kind&quot;:&quot;Route&quot;,&quot;name&quot;:&quot;grafana-route&quot;}}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  dashboardLabelSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - matchExpressions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - { key: &quot;app&quot;, operator: In, values: [&#x27;grafana&#x27;] }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: grafana-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - apiGroups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      - authentication.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      - tokenreviews</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    verbs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      - create</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - apiGroups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      - authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      - subjectaccessreviews</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    verbs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      - create</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: RoleBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: grafana-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">roleRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  apiGroup: rbac.authorization.k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  kind: ClusterRole</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: grafana-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">subjects:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - kind: ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    name: grafana-serviceaccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  session_secret: Y2hhbmdlIG1lCg==</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: grafana-k8s-proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">type: Opaque</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">waitForStatus </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  grafanas.integreatly.org </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  grafana </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">400</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;{.status.phase}&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;failing&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Ignore error if svc grafana-alert has no annotations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oc patch svc grafana-alert --type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">json -p</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;[{&quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/metadata/annotations&quot;}]&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oc delete secret grafana-k8s-tls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oc annotate </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> grafana-service </span><span class="token assign-left variable" style="color:#36acaa">fixed</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oc adm policy add-cluster-role-to-user cluster-monitoring-view -z grafana-serviceaccount -n monitoring-grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oc create -n monitoring-grafana -f - </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: grafana-auth-secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    kubernetes.io/service-account.name: grafana-serviceaccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">type: kubernetes.io/service-account-token</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oc create -n monitoring-grafana -f - </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: integreatly.org/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: GrafanaDataSource</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  datasources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - access: proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      editable: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      isDefault: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      jsonData:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        httpHeaderName1: &#x27;Authorization&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        timeInterval: 5s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        tlsSkipVerify: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      name: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      secureJsonData:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        httpHeaderValue1: &#x27;Bearer \</span><span class="token string variable" style="color:#36acaa">${GRAFANA_TOKEN}</span><span class="token string" style="color:#e3116c">&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      type: prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      url: &#x27;https://thanos-querier.openshift-monitoring.svc.cluster.local:9091&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: prometheus.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Monitoring will be available at https://</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable" style="color:#36acaa">oc get route -n monitoring-grafana grafana-route -o </span><span class="token string variable assign-left variable" style="color:#36acaa">jsonpath</span><span class="token string variable operator" style="color:#393A34">=</span><span class="token string variable string" style="color:#e3116c">&#x27;{.status.ingress[0].host}&#x27;</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Alternatively, there is a <a href="https://cloud.redhat.com/experts/o11y/ocp-grafana/" target="_blank" rel="noopener noreferrer">RedHat blog</a> which details
how to deploy grafana and connect to Thanos.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="creating-dashboards">Creating dashboards<a href="#creating-dashboards" class="hash-link" aria-label="Direct link to Creating dashboards" title="Direct link to Creating dashboards">​</a></h4><p>All the same queries listed above for the OCP console will work in Grafana too, and can be attached to any
of the available visualizations.</p><p>There are some example dashboards available in
<a href="https://github.com/IBM/waiops-tech-jam/tree/main/labs/practitioner-basics/4-monitoring/example-dashboards" target="_blank" rel="noopener noreferrer">example-dashboards</a>,
which can be imported into Grafana.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/IBM/waiops-tech-jam/tree/main/labs/practitioner-basics/4-monitoring/configuring-self-monitoring.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/waiops-tech-jam/labs/practitioner-basics/storage/data-foundation/maintenance/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Reclaiming Free Space</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/waiops-tech-jam/labs/instana/introduction/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Labs Overview</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#examining-kpis-and-other-metrics-using-user-workload-monitoring" class="table-of-contents__link toc-highlight">Examining KPIs and other metrics using User Workload Monitoring</a><ul><li><a href="#enabling-user-workload-monitoring" class="table-of-contents__link toc-highlight">Enabling user workload monitoring</a></li><li><a href="#viewing-metrics-in-the-ocp-console" class="table-of-contents__link toc-highlight">Viewing metrics in the OCP console</a></li><li><a href="#enabling-additional-metrics" class="table-of-contents__link toc-highlight">Enabling additional metrics</a></li><li><a href="#viewing-metrics-in-grafana" class="table-of-contents__link toc-highlight">Viewing metrics in Grafana</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.ibm.com/docs/en/cloud-paks/cloud-pak-watson-aiops" target="_blank" rel="noopener noreferrer" class="footer__link-item">CP4AIOps<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.ibm.com/docs/en/noi/" target="_blank" rel="noopener noreferrer" class="footer__link-item">NOI<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.ibm.com/docs/en/obi/current" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instana<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.turbonomic.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Turbonomic<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.ibm.com/au-en" target="_blank" rel="noopener noreferrer" class="footer__link-item">IBM<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/waiops-tech-jam/blog/">Blog</a></li><li class="footer__item"><a href="https://github.com/IBM/waiops-tech-jam" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/waiops-tech-jam/assets/js/runtime~main.bf944562.js"></script>
<script src="/waiops-tech-jam/assets/js/main.df3d1d6f.js"></script>
</body>
</html>